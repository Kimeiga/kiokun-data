<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiokun Dictionary</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .character {
            font-size: 96px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            font-family: 'SimSun', 'MS Mincho', serif;
        }

        .badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-hsk { background: #3498db; color: white; }
        .badge-jlpt { background: #e74c3c; color: white; }
        .badge-grade { background: #9b59b6; color: white; }
        .badge-freq { background: #27ae60; color: white; }
        .badge-stroke { background: #f39c12; color: white; }

        /* Section Styles */
        .section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            font-size: 24px;
            font-weight: bold;
        }

        .section-header.chinese {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        .section-header.japanese {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .section-content {
            padding: 30px;
        }

        .subsection {
            margin-bottom: 30px;
        }

        .subsection:last-child {
            margin-bottom: 0;
        }

        .subsection-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        /* Data Display */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #3498db;
        }

        .data-item.japanese {
            border-left-color: #e74c3c;
        }

        .data-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
        }

        .data-value.large {
            font-size: 20px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        /* Word Entries */
        .word-entry {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .word-entry:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .word-reading {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .word-definitions {
            margin: 10px 0;
        }

        .definition-item {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .definition-item:last-child {
            border-bottom: none;
        }

        .definition-text {
            color: #495057;
            line-height: 1.5;
        }

        .pos-tag {
            display: inline-block;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: #6c757d;
            margin-right: 8px;
            text-transform: uppercase;
        }

        /* Character Components */
        .components-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .component-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 24px;
            font-family: 'SimSun', 'MS Mincho', serif;
        }

        .component-item.meaning {
            border-color: #3498db;
        }

        .component-item.phonetic {
            border-color: #e74c3c;
        }

        /* IDS Display */
        .ids-display {
            font-size: 48px;
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'SimSun', 'MS Mincho', serif;
        }

        /* Etymology */
        .etymology-box {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 15px 0;
            font-style: italic;
            line-height: 1.8;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }



        /* Readings Display */
        .readings-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }

        .reading-chip {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 8px 15px;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
        }

        .reading-chip.pinyin {
            border-color: #3498db;
            color: #3498db;
        }

        .reading-chip.onyomi {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .reading-chip.kunyomi {
            border-color: #9b59b6;
            color: #9b59b6;
        }

        .reading-chip.nanori {
            border-color: #27ae60;
            color: #27ae60;
        }

        /* Utility */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #e74c3c;
            background: #fdf2f2;
            border-radius: 12px;
            margin: 20px 0;
        }

        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 15px 25px;
            border: 2px solid #e9ecef;
            border-radius: 30px;
            font-size: 18px;
            margin: 0 auto;
            display: block;
            text-align: center;
            font-family: 'SimSun', 'MS Mincho', serif;
        }

        .search-box:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .list-item {
            padding: 8px 0;
            line-height: 1.6;
        }

        .list-item::before {
            content: "• ";
            color: #3498db;
            font-weight: bold;
            margin-right: 8px;
        }

        @media (max-width: 768px) {
            .character { font-size: 64px; }
            .container { padding: 10px; }
            .data-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .section-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="margin-bottom: 20px; color: #2c3e50;">📚 Kiokun Dictionary</h1>
            <input type="text" class="search-box" placeholder="Enter a character or word (e.g., 好, 地図)" id="searchBox">
        </div>

        <div id="content">
            <div class="loading">
                <p>Enter a character or word above to explore its meanings</p>
                <p style="margin-top: 10px; font-size: 14px; opacity: 0.7;">Try: 好, 的, 和, 空, 地図</p>
            </div>
        </div>
    </div>

    <script>
        class KiokunApp {
            constructor() {
                this.currentWord = null;
                this.setupEventListeners();
                this.loadFromURL();
            }

            setupEventListeners() {
                const searchBox = document.getElementById('searchBox');
                searchBox.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const word = e.target.value.trim();
                        if (word) {
                            this.loadWord(word);
                        }
                    }
                });

                window.addEventListener('popstate', (e) => {
                    if (e.state && e.state.word) {
                        this.loadWord(e.state.word, false);
                    } else {
                        this.loadFromURL();
                    }
                });
            }

            loadFromURL() {
                const path = window.location.pathname;
                if (path !== '/') {
                    const word = decodeURIComponent(path.substring(1));
                    if (word) {
                        document.getElementById('searchBox').value = word;
                        this.loadWord(word, false);
                    }
                }
            }

            async loadWord(word, updateURL = true) {
                const content = document.getElementById('content');
                content.innerHTML = '<div class="loading">Loading...</div>';

                try {
                    const response = await fetch(`../output_dictionary/${word}.json`);
                    if (!response.ok) {
                        throw new Error(`"${word}" not found`);
                    }

                    const data = await response.json();
                    this.currentWord = word;
                    this.renderData(data);

                    if (updateURL) {
                        window.history.pushState({word}, '', `/${word}`);
                    }
                } catch (error) {
                    content.innerHTML = `
                        <div class="error">
                            <h2>❌ Not Found</h2>
                            <p>${error.message}</p>
                            <p>Try: 好, 的, 和, 空</p>
                        </div>
                    `;
                }
            }

            async renderData(data) {
                const content = document.getElementById('content');
                const key = data.key || this.currentWord;

                let html = `
                    <div class="header" style="margin-bottom: 30px;">
                        <div class="character">${key}</div>
                        ${this.renderBadges(data)}
                    </div>
                `;

                // Chinese Character
                if (data.chinese_char) {
                    html += this.renderChineseChar(data.chinese_char);
                }

                // Japanese Character
                if (data.japanese_char) {
                    html += this.renderJapaneseChar(data.japanese_char);
                }

                // Chinese Words
                if (data.chinese_words && data.chinese_words.length > 0) {
                    html += this.renderChineseWords(data.chinese_words);
                }

                // Japanese Words
                if (data.japanese_words && data.japanese_words.length > 0) {
                    html += this.renderJapaneseWords(data.japanese_words);
                }

                content.innerHTML = html;

                // Fetch and display related Japanese words
                if (data.related_japanese_words && data.related_japanese_words.length > 0) {
                    await this.renderRelatedJapaneseWords(data.related_japanese_words);
                }
            }

            renderBadges(data) {
                const badges = [];

                // Chinese character stats
                if (data.chinese_char?.statistics?.hskLevel) {
                    badges.push(`<span class="badge badge-hsk">HSK ${data.chinese_char.statistics.hskLevel}</span>`);
                }

                // Japanese character stats
                if (data.japanese_char?.misc?.grade) {
                    badges.push(`<span class="badge badge-grade">Grade ${data.japanese_char.misc.grade}</span>`);
                }

                if (data.japanese_char?.misc?.jlptLevel) {
                    badges.push(`<span class="badge badge-jlpt">JLPT N${data.japanese_char.misc.jlptLevel}</span>`);
                }

                if (data.japanese_char?.misc?.frequency) {
                    badges.push(`<span class="badge badge-freq">Freq: ${data.japanese_char.misc.frequency}</span>`);
                }

                if (data.chinese_char?.strokeCount) {
                    badges.push(`<span class="badge badge-stroke">${data.chinese_char.strokeCount} strokes</span>`);
                }

                return badges.length > 0 ? `<div class="badges">${badges.join('')}</div>` : '';
            }

            renderChineseChar(char) {
                let html = `
                    <div class="section">
                        <div class="section-header chinese">🇨🇳 Chinese Character</div>
                        <div class="section-content">
                `;

                // Pinyin readings
                if (char.pinyinFrequencies && char.pinyinFrequencies.length > 0) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Pinyin Readings</div>
                        <div class="readings-list">`;
                    char.pinyinFrequencies.forEach(item => {
                        html += `<span class="reading-chip pinyin">${item.pinyin}</span>`;
                    });
                    html += `</div></div>`;
                }

                // Gloss
                if (char.gloss) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Meaning</div>
                        <div class="data-value large">${char.gloss}</div>
                    </div>`;
                }

                // Etymology (Shuowen)
                if (char.shuowen) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Etymology (說文解字)</div>
                        <div class="etymology-box">${char.shuowen}</div>
                    </div>`;
                }

                // Components
                if (char.components && char.components.length > 0) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Components</div>
                        <div class="components-list">`;
                    char.components.forEach(comp => {
                        const typeClass = comp.type.includes('meaning') ? 'meaning' : 'phonetic';
                        html += `<div class="component-item ${typeClass}" title="${comp.type.join(', ')}">${comp.character}</div>`;
                    });
                    html += `</div></div>`;
                }

                // Old Pronunciations (Middle Chinese, Old Chinese)
                if (char.oldPronunciations && char.oldPronunciations.length > 0) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Historical Pronunciations</div>`;
                    char.oldPronunciations.forEach(old => {
                        html += `<div style="margin-bottom: 10px; padding: 12px; background: #fff9e6; border-left: 3px solid #f39c12; border-radius: 0 6px 6px 0;">`;
                        html += `<div style="font-weight: bold; margin-bottom: 5px;">${old.pinyin} - ${old.gloss}</div>`;
                        if (old.MC) html += `<div style="font-size: 14px; color: #7f8c8d;">Middle Chinese: <span style="font-family: monospace; color: #2c3e50;">${old.MC}</span></div>`;
                        if (old.OC) html += `<div style="font-size: 14px; color: #7f8c8d;">Old Chinese: <span style="font-family: monospace; color: #2c3e50;">${old.OC}</span></div>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                }

                // Variants
                if (char.variants && char.variants.length > 0) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Variants</div>
                        <div class="components-list">`;
                    char.variants.forEach(variant => {
                        if (variant.char) {
                            html += `<div class="component-item" title="${variant.parts || ''}">${variant.char}</div>`;
                        }
                    });
                    html += `</div></div>`;
                }

                // Statistics
                if (char.statistics) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Statistics</div>
                        <div class="stats-grid">`;
                    if (char.statistics.hskLevel) {
                        html += `<div class="stat-item">
                            <div class="stat-value">${char.statistics.hskLevel}</div>
                            <div class="stat-label">HSK Level</div>
                        </div>`;
                    }
                    if (char.strokeCount) {
                        html += `<div class="stat-item">
                            <div class="stat-value">${char.strokeCount}</div>
                            <div class="stat-label">Strokes</div>
                        </div>`;
                    }
                    html += `</div></div>`;
                }

                html += `</div></div>`;
                return html;
            }

            renderJapaneseChar(char) {
                let html = `
                    <div class="section">
                        <div class="section-header japanese">🇯🇵 Japanese Character</div>
                        <div class="section-content">
                `;

                // Readings
                if (char.readingMeaning?.groups) {
                    const group = char.readingMeaning.groups[0];
                    if (group?.readings) {
                        const onyomi = group.readings.filter(r => r.type === 'ja_on').map(r => r.value);
                        const kunyomi = group.readings.filter(r => r.type === 'ja_kun').map(r => r.value);
                        const nanori = group.readings.filter(r => r.type === 'ja_nanori').map(r => r.value);

                        html += `<div class="subsection">
                            <div class="subsection-title">Readings</div>
                            <div class="readings-list">`;

                        onyomi.forEach(r => html += `<span class="reading-chip onyomi">音: ${r}</span>`);
                        kunyomi.forEach(r => html += `<span class="reading-chip kunyomi">訓: ${r}</span>`);
                        nanori.forEach(r => html += `<span class="reading-chip nanori">名: ${r}</span>`);

                        html += `</div></div>`;
                    }

                    // Meanings
                    if (group?.meanings) {
                        html += `<div class="subsection">
                            <div class="subsection-title">Meanings</div>`;
                        group.meanings.forEach(m => {
                            // Handle both string and object formats
                            const meaning = typeof m === 'string' ? m : (m.value || m.text || m);
                            html += `<div class="list-item">${meaning}</div>`;
                        });
                        html += `</div>`;
                    }
                }

                // Radicals
                if (char.radicals && char.radicals.length > 0) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Radicals</div>
                        <div class="data-grid">`;
                    char.radicals.forEach(rad => {
                        html += `<div class="data-item japanese">
                            <div class="data-label">${rad.type}</div>
                            <div class="data-value large">${rad.value}</div>
                        </div>`;
                    });
                    html += `</div></div>`;
                }

                // Misc info
                if (char.misc) {
                    html += `<div class="subsection">
                        <div class="subsection-title">Information</div>
                        <div class="stats-grid">`;
                    if (char.misc.grade) {
                        html += `<div class="stat-item">
                            <div class="stat-value">${char.misc.grade}</div>
                            <div class="stat-label">Grade</div>
                        </div>`;
                    }
                    if (char.misc.strokeCounts && char.misc.strokeCounts.length > 0) {
                        html += `<div class="stat-item">
                            <div class="stat-value">${char.misc.strokeCounts[0]}</div>
                            <div class="stat-label">Strokes</div>
                        </div>`;
                    }
                    if (char.misc.jlptLevel) {
                        html += `<div class="stat-item">
                            <div class="stat-value">N${char.misc.jlptLevel}</div>
                            <div class="stat-label">JLPT</div>
                        </div>`;
                    }
                    if (char.misc.frequency) {
                        html += `<div class="stat-item">
                            <div class="stat-value">${char.misc.frequency}</div>
                            <div class="stat-label">Frequency</div>
                        </div>`;
                    }
                    html += `</div></div>`;
                }

                html += `</div></div>`;
                return html;
            }

            renderChineseWords(words) {
                let html = `
                    <div class="section">
                        <div class="section-header chinese">📖 Chinese Words</div>
                        <div class="section-content">
                `;

                words.forEach(word => {
                    html += `<div class="word-entry">`;

                    // Word header
                    html += `<div style="margin-bottom: 15px;">
                        <span style="font-size: 24px; font-weight: bold; font-family: 'SimSun', serif;">${word.simp}</span>`;
                    if (word.trad && word.trad !== word.simp) {
                        html += ` <span style="font-size: 20px; color: #7f8c8d;">(${word.trad})</span>`;
                    }
                    if (word.gloss) {
                        html += ` <span style="margin-left: 15px; color: #27ae60; font-weight: 600;">${word.gloss}</span>`;
                    }
                    html += `</div>`;

                    // Items (different pronunciations/definitions)
                    if (word.items && word.items.length > 0) {
                        // Filter out items without definitions
                        const itemsWithDefs = word.items.filter(item =>
                            item.definitions && item.definitions.length > 0
                        );

                        itemsWithDefs.forEach(item => {
                            html += `<div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">`;

                            if (item.pinyin) {
                                html += `<div class="word-reading">${item.pinyin}</div>`;
                            }

                            if (item.definitions && item.definitions.length > 0) {
                                // Join all definitions with semicolons on one line
                                const definitionsText = item.definitions.join('; ');
                                html += `<div class="definition-text" style="margin: 10px 0; line-height: 1.6;">${definitionsText}</div>`;
                            }

                            html += `</div>`;
                        });
                    }

                    // Statistics
                    if (word.statistics) {
                        html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">`;
                        if (word.statistics.hskLevel) {
                            html += `<span class="badge badge-hsk">HSK ${word.statistics.hskLevel}</span>`;
                        }
                        html += `</div>`;
                    }

                    html += `</div>`;
                });

                html += `</div></div>`;
                return html;
            }



            async renderRelatedJapaneseWords(relatedKeys) {
                const content = document.getElementById('content');

                // Add a section for related words
                let html = `
                    <div class="section">
                        <div class="section-header japanese">🔗 Related Japanese Words</div>
                        <div class="section-content">
                            <div class="subsection">
                                <div class="subsection-title">Words where "${this.currentWord}" appears as an alternative kanji form</div>
                                <div id="related-words-container">Loading...</div>
                            </div>
                        </div>
                    </div>
                `;

                content.innerHTML += html;

                // Fetch each related entry
                const relatedWordsContainer = document.getElementById('related-words-container');
                let relatedHtml = '';

                for (const relatedKey of relatedKeys) {
                    try {
                        const response = await fetch(`../output_dictionary/${relatedKey}.json`);
                        if (response.ok) {
                            const relatedData = await response.json();
                            if (relatedData.japanese_words && relatedData.japanese_words.length > 0) {
                                relatedHtml += this.renderJapaneseWords(relatedData.japanese_words, relatedKey);
                            }
                        }
                    } catch (error) {
                        console.error(`Failed to fetch related word: ${relatedKey}`, error);
                    }
                }

                relatedWordsContainer.innerHTML = relatedHtml || '<div class="empty-state">No related words found</div>';
            }

            renderJapaneseWords(words, sourceKey = null) {
                let html = '';

                // If sourceKey is provided, we're rendering related words (don't add section wrapper)
                const isRelated = sourceKey !== null;

                if (!isRelated) {
                    html += `
                        <div class="section">
                            <div class="section-header japanese">📖 Japanese Words</div>
                            <div class="section-content">
                    `;
                }

                words.forEach(word => {
                    html += `<div class="word-entry">`;

                    // Kanji and Kana
                    html += `<div style="margin-bottom: 15px;">`;
                    if (word.kanji && word.kanji.length > 0) {
                        html += `<span style="font-size: 24px; font-weight: bold; font-family: 'MS Mincho', serif;">${word.kanji[0].text}</span> `;

                        // Show all kanji forms
                        if (word.kanji.length > 1) {
                            html += `<span style="font-size: 16px; color: #7f8c8d;">(`;
                            html += word.kanji.slice(1).map(k => k.text).join(', ');
                            html += `)</span> `;
                        }
                    }
                    if (word.kana && word.kana.length > 0) {
                        html += `<span style="font-size: 20px; color: #e74c3c; font-family: 'MS Mincho', serif;">[${word.kana.map(k => k.text).join(', ')}]</span>`;
                    }
                    if (sourceKey) {
                        html += ` <span style="margin-left: 10px; font-size: 14px; color: #7f8c8d;">from ${sourceKey}</span>`;
                    }
                    html += `</div>`;

                    // Senses (meanings)
                    if (word.sense && word.sense.length > 0) {
                        word.sense.forEach((sense, idx) => {
                            html += `<div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">`;

                            // Part of speech tags
                            if (sense.partOfSpeech && sense.partOfSpeech.length > 0) {
                                sense.partOfSpeech.forEach(pos => {
                                    html += `<span class="pos-tag">${pos}</span>`;
                                });
                            }

                            // Glosses - join with semicolons on one line
                            if (sense.gloss && sense.gloss.length > 0) {
                                const glossText = sense.gloss.map(g => g.text).join('; ');
                                html += `<div class="definition-text" style="margin-top: 10px; line-height: 1.6;">${glossText}</div>`;
                            }

                            html += `</div>`;
                        });
                    }

                    html += `</div>`;
                });

                if (!isRelated) {
                    html += `</div></div>`;
                }

                return html;
            }
        }

        // Initialize the app
        const app = new KiokunApp();
    </script>
</body>
</html>
